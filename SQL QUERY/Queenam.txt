WITH ContactRanked AS (
    SELECT 
        T4."CardCode", 
        T4."Name" AS "Contact Person",
        ROW_NUMBER() OVER (PARTITION BY T4."CardCode" ORDER BY T4."CntctCode") AS "RowNum"
    FROM PRD.OCPR T4
)
SELECT DISTINCT
    T2."CardCode" AS "Customer Code", -- MÃ£ khÃ¡ch hÃ ng
    T2."CardName" AS "Customer Name", -- TÃªn khÃ¡ch hÃ ng
    T0."ItemCode" AS "Item Code", -- MÃ£ sáº£n pháº©m
    T1."ItemName" AS "Item Name", -- TÃªn sáº£n pháº©m
    T1."SalUnitMsr" AS "Sale UoM", -- ÄÆ¡n vá»‹ bÃ¡n
    T0."Quantity" AS "Quantity Sold", -- Sá»‘ lÆ°á»£ng sáº£n pháº©m Ä‘Ã£ bÃ¡n
    T0."LineTotal" AS "Total Amount without VAT", -- GiÃ¡ tá»•ng trÆ°á»›c thuáº¿ (Ä‘Ã£ discount)

    -- TÃ­nh giÃ¡ tá»•ng sau thuáº¿
    ROUND(T0."LineTotal" * (1 + (T0."VatPrcnt" / 100)), 2) AS "Total Amount with VAT", -- GiÃ¡ tá»•ng sau thuáº¿

    -- TÃ­nh giÃ¡ discount tá»«ng bá»‹ch
    CASE
        WHEN T0."Quantity" > 0 THEN ROUND(T0."LineTotal" / T0."Quantity", 2)
        ELSE NULL
    END AS "Discounted Price per Pack", -- GiÃ¡ tá»«ng bá»‹ch khÃ´ng thuáº¿

    -- TÃ­nh giÃ¡ tá»«ng bá»‹ch sau thuáº¿
    CASE
        WHEN T0."Quantity" > 0 THEN ROUND((T0."LineTotal" * (1 + (T0."VatPrcnt" / 100))) / T0."Quantity", 2)
        ELSE NULL
    END AS "Price per Pack with VAT", -- GiÃ¡ tá»«ng bá»‹ch cÃ³ thuáº¿

    T3."DocNum" AS "Invoice Number", -- Sá»‘ hÃ³a Ä‘Æ¡n

    -- Chuyá»ƒn Ä‘á»•i ngÃ y thÃ¡ng Ä‘á»ƒ trÃ¡nh lá»—i Ä‘á»‹nh dáº¡ng trong Excel
    TO_VARCHAR(T3."DocDate", 'DD/MM/YYYY') AS "Invoice Date", -- NgÃ y hÃ³a Ä‘Æ¡n

    CR."Contact Person", -- NgÆ°á»i liÃªn há»‡ duy nháº¥t liÃªn quan Ä‘áº¿n Invoice

    T5."SlpName" AS "Sales Employee Name", -- NhÃ¢n viÃªn bÃ¡n hÃ ng

    -- ğŸ†• ThÃªm cá»™t QuÃ½
    QUARTER(T3."DocDate") AS "Quarter", -- XÃ¡c Ä‘á»‹nh quÃ½ (1-4)

    -- ğŸ†• ThÃªm cá»™t NÄƒm-ThÃ¡ng Ä‘á»ƒ dá»… sort
    TO_VARCHAR(T3."DocDate", 'YYYY-MM') AS "Year-Month" -- Hiá»ƒn thá»‹ nÄƒm-thÃ¡ng

FROM
    PRD.INV1 T0 -- DÃ²ng cá»§a hÃ³a Ä‘Æ¡n
LEFT JOIN
    PRD.OITM T1 ON T0."ItemCode" = T1."ItemCode" -- ThÃ´ng tin sáº£n pháº©m
LEFT JOIN
    PRD.OINV T3 ON T0."DocEntry" = T3."DocEntry" -- HÃ³a Ä‘Æ¡n chÃ­nh
LEFT JOIN
    PRD.OCRD T2 ON T3."CardCode" = T2."CardCode" -- ThÃ´ng tin khÃ¡ch hÃ ng
LEFT JOIN
    ContactRanked CR ON T2."CardCode" = CR."CardCode" AND CR."RowNum" = 1 -- Láº¥y Contact Person Ä‘áº§u tiÃªn
LEFT JOIN
    PRD.OSLP T5 ON T3."SlpCode" = T5."SlpCode" -- ThÃ´ng tin nhÃ¢n viÃªn bÃ¡n hÃ ng
WHERE T0."ItemCode" IN ('32D90002', '32D91231', '32D91232', '32D93333', '32D93334', '32D93335', '32D95322', '32D96329', '32D97320', '32D98326', '32D9O326', '32T83220', '32D90003', '32D91234', '32D91233', '32D93340', '32D93338', '32D93339', '32D95323', '32D96330', '32D97321', '32D98327', '32D9O327', '32T83221')
ORDER BY
    T2."CardCode", 
    T3."DocNum", 
    "Year-Month" DESC, -- Sáº¯p xáº¿p theo nÄƒm-thÃ¡ng trÆ°á»›c
    "Quarter" DESC, -- Sau Ä‘Ã³ sáº¯p xáº¿p theo quÃ½
    T0."ItemCode";
