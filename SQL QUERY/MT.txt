WITH ContactRanked AS (
    SELECT 
        T4."CardCode", 
        T4."Name" AS "Contact Person",
        ROW_NUMBER() OVER (PARTITION BY T4."CardCode" ORDER BY T4."CntctCode") AS "RowNum"
    FROM PRD.OCPR T4
)
SELECT DISTINCT
    T2."CardCode" AS "Customer Code", -- M√£ kh√°ch h√†ng
    T2."CardName" AS "Customer Name", -- T√™n kh√°ch h√†ng
    T0."ItemCode" AS "Item Code", -- M√£ s·∫£n ph·∫©m
    T1."ItemName" AS "Item Name", -- T√™n s·∫£n ph·∫©m
    T1."SalUnitMsr" AS "Sale UoM", -- ƒê∆°n v·ªã b√°n
    T0."Quantity" AS "Quantity Sold", -- S·ªë l∆∞·ª£ng s·∫£n ph·∫©m ƒë√£ b√°n
    T0."LineTotal" AS "Total Amount without VAT", -- Gi√° t·ªïng tr∆∞·ªõc thu·∫ø (ƒë√£ discount)

    -- T√≠nh gi√° t·ªïng sau thu·∫ø
    ROUND(T0."LineTotal" * (1 + (T0."VatPrcnt" / 100)), 2) AS "Total Amount with VAT", -- Gi√° t·ªïng sau thu·∫ø

    -- T√≠nh gi√° discount t·ª´ng b·ªãch
    CASE
        WHEN T0."Quantity" > 0 THEN ROUND(T0."LineTotal" / T0."Quantity", 2)
        ELSE NULL
    END AS "Discounted Price per Pack", -- Gi√° t·ª´ng b·ªãch kh√¥ng thu·∫ø

    -- T√≠nh gi√° t·ª´ng b·ªãch sau thu·∫ø
    CASE
        WHEN T0."Quantity" > 0 THEN ROUND((T0."LineTotal" * (1 + (T0."VatPrcnt" / 100))) / T0."Quantity", 2)
        ELSE NULL
    END AS "Price per Pack with VAT", -- Gi√° t·ª´ng b·ªãch c√≥ thu·∫ø

    T3."DocNum" AS "Invoice Number", -- S·ªë h√≥a ƒë∆°n

    -- Chuy·ªÉn ƒë·ªïi ng√†y th√°ng ƒë·ªÉ tr√°nh l·ªói ƒë·ªãnh d·∫°ng trong Excel
    TO_VARCHAR(T3."DocDate", 'DD/MM/YYYY') AS "Invoice Date", -- Ng√†y h√≥a ƒë∆°n

    CR."Contact Person", -- Ng∆∞·ªùi li√™n h·ªá duy nh·∫•t li√™n quan ƒë·∫øn Invoice

    T5."SlpName" AS "Sales Employee Name", -- Nh√¢n vi√™n b√°n h√†ng

    -- üÜï Th√™m c·ªôt Qu√Ω
    QUARTER(T3."DocDate") AS "Quarter", -- X√°c ƒë·ªãnh qu√Ω (1-4)

    -- üÜï Th√™m c·ªôt NƒÉm-Th√°ng ƒë·ªÉ d·ªÖ sort
    TO_VARCHAR(T3."DocDate", 'YYYY-MM') AS "Year-Month" -- Hi·ªÉn th·ªã nƒÉm-th√°ng

FROM
    PRD.INV1 T0 -- D√≤ng c·ªßa h√≥a ƒë∆°n
LEFT JOIN
    PRD.OITM T1 ON T0."ItemCode" = T1."ItemCode" -- Th√¥ng tin s·∫£n ph·∫©m
LEFT JOIN
    PRD.OINV T3 ON T0."DocEntry" = T3."DocEntry" -- H√≥a ƒë∆°n ch√≠nh
LEFT JOIN
    PRD.OCRD T2 ON T3."CardCode" = T2."CardCode" -- Th√¥ng tin kh√°ch h√†ng
LEFT JOIN
    ContactRanked CR ON T2."CardCode" = CR."CardCode" AND CR."RowNum" = 1 -- L·∫•y Contact Person ƒë·∫ßu ti√™n
LEFT JOIN
    PRD.OSLP T5 ON T3."SlpCode" = T5."SlpCode" -- Th√¥ng tin nh√¢n vi√™n b√°n h√†ng
WHERE
    T2."CardCode" IN (
'211.047', '211.057', '211.058', '211.059', '211.060', '211.061', '216.012', '211.062', '216.014', '216.015', '216.016', '216.017', '216.018', '216.019', '216.020', '216.021', '211.063', '216.022', '216.023', '216.024', '216.025', '211.064', '216.026', '216.027', '216.028', '211.065', '211.066', '216.029', '211.067', '211.068', '211.069', '211.070', '211.071', '216.030', '211.072', '216.032', '216.013', '216.031', '216.033', '211.073', '211.074', '211.075', '211.076', '211.077', '211.078', '211.079', '211.080', '216.034', '211.081', '211.082', '211.084', '211.083', '211.085', '211.086', '211.087', '211.088', '211.089', '211.090', '211.091', '211.092', '211.048', '211.050', '211.051', '211.052', '211.053', '216.009', '216.007', '211.046', '211.044', '211.105', '211.106', '211.107', '211.108', '211.049', '211.055', '216.036', '216.008', '216.037', '216.038', '216.039', '216.040', '216.041', '216.042', '216.043', '216.044', '216.045', '216.046', '216.047', '216.048', '216.049', '216.050', '216.051', '216.052', '216.053', '216.054', '216.055', '216.056', '216.057', '216.058', '216.059', '216.060', '216.061', '216.062', '216.063', '216.064', '216.065', '216.066', '216.084', '216.083', '216.082', '216.081', '216.080', '216.079', '216.077', '216.078', '216.076', '216.075', '216.074', '216.073', '216.072', '216.071', '216.070', '216.069', '216.068', '216.067', '211.119', '211.120', '211.056', '211.093', '211.094', '211.095', '211.097', '211.098', '211.099', '211.100', '211.102', '211.103', '211.104', '211.110', '211.111', '211.112', '211.113', '211.114', '211.115', '211.116', '211.117', '211.118', '211.121', '211.109', '211.123', '211.124', '211.125', '211.126', '211.127', '216.085', '216.086', '211128'
    )
ORDER BY
    T2."CardCode", 
    T3."DocNum", 
    "Year-Month" DESC, -- S·∫Øp x·∫øp theo nƒÉm-th√°ng
    "Quarter" DESC, -- S·∫Øp x·∫øp theo qu√Ω
    T0."ItemCode";


